fmt:
    nix fmt

check:
    nix flake check -L

lint:
    set -eu
    statix check -- .
    deadnix --fail .
    if git ls-files -- '*.py' >/dev/null 2>&1; then \
      ruff check -- .; \
      black --check --line-length 100 --extend-exclude '(secrets/crypted|modules/user/gui/kitty/conf/tab_bar.py)' .; \
    fi
    files=$(git ls-files '*.sh' '*.bash' || true); \
    if [ -n "$files" ]; then \
      shellcheck -S style -x $files; \
    fi

hm-neg:
    home-manager switch --flake .#neg

hm-lite:
    home-manager switch --flake .#neg-lite

hm-build:
    # Build activation package without switching
    home-manager build --flake .#neg

hooks-enable:
    git config core.hooksPath .githooks

show-features names*:
    # Print flattened features for given check names (or default matrix)
    # Usage:
    #   just show-features                        # all default items
    #   just show-features hm-eval-neg-retro-on   # specific item(s)
    #   ONLY_TRUE=1 just show-features            # show only feature keys with value=true
    set -eu
    sys=${SYSTEM:-x86_64-linux}
    if [ "$#" -gt 0 ]; then \
      items=("$@"); \
    else \
      items=( \
        hm-eval-neg-retro-on \
        hm-eval-neg-retro-off \
        hm-eval-lite-retro-on \
        hm-eval-lite-retro-off \
      ); \
    fi
    for name in "${items[@]}"; do \
      echo "== ${name} (system=${sys}) =="; \
      out=$(nix build --no-link --print-out-paths ".#checks.${sys}.${name}"); \
      if command -v jq >/dev/null 2>&1; then \
        if [ "${ONLY_TRUE:-}" = "1" ]; then \
          jq -r 'to_entries|map(select(.value==true).key)|.[]' <"$out"; \
        else \
          jq . <"$out"; \
        fi; \
      else \
        cat "$out"; \
      fi; \
      echo; \
    done

hm-status:
    set -eu
    echo "== systemd --user failed units =="
    systemctl --user --failed || true
    echo
    echo "== recent user journal =="
    journalctl --user -b -n 120 --no-pager || true

clean-caches:
    set -eu
    repo=$(git rev-parse --show-toplevel)
    find "$repo" -type f -name '*.zwc' -delete || true
    find "$repo" -type d -name '__pycache__' -prune -exec rm -rf {} + || true
    find "$repo" -type f -name '*.pyc' -delete || true
    rm -rf "$repo/nix/.config/home-manager/.cache" || true
    : "${XDG_CACHE_HOME:=$HOME/.cache}"
    : "${XDG_STATE_HOME:=$HOME/.local/state}"
    rm -rf "$XDG_CACHE_HOME/zsh" || true
    rm -rf "$XDG_CACHE_HOME/nu" "$XDG_CACHE_HOME/nushell" || true
    rm -f "$XDG_STATE_HOME/nushell/history.sqlite3"* || true
