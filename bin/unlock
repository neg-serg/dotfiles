#!/bin/sh
set -eu
if (set -o pipefail) 2>/dev/null; then
  set -o pipefail
fi
# unlock: unlock SSH keys (optionally Yubikey) via expect using pass(1) secrets
# Usage: unlock
if [ "${1:-}" = "-h" ] || [ "${1:-}" = "--help" ]; then
  sed -n '2,2p' "$0" | sed 's/^# \{0,1\}//'; exit 0
fi
. /etc/profile
pp0="$(pass show ssh-key)"
pp2="$(pass show wrk/ssh-key)"
if lsusb | grep -q "0407 Yubico"; then
    pp1="$(pass show pin)"
    expect << EOF
        spawn "$XDG_CONFIG_HOME/zsh-nix/ylock"
        expect "Enter passphrase"
        send "$pp1\r"
        expect eof
EOF
fi
expect << EOF
    spawn ssh-add $HOME/.ssh/id_neg
    expect "Enter passphrase"
    send "$pp0\r"
    expect eof
EOF
