#!/bin/sh
set -eu
if (set -o pipefail) 2>/dev/null; then
  set -o pipefail
fi
# qr: quick QR and screenshot helper
# Usage:
#   qr gen          # generate QR from current selection to ~/tmp/qrcode.png
#   qr select       # select region → clipboard (PNG) + notify
#   qr qr           # select region → scan QR → copy result + notify
#   qr              # screenshot entire desktop → clipboard (PNG) + notify
#   qr -h|--help    # this help

maimselect() { grim -g "$(slurp)" -; }
clip() { # usage: clip [-t mimetype] (reads from stdin)
  local mimetype="${1:-}"
  if [ "$1" = "-t" ] || [ "$1" = "--type" ]; then shift; mimetype="${1:-}"; shift || true; fi
  if [ -n "$mimetype" ]; then wl-copy --type "$mimetype"; else wl-copy; fi
}

case "${1:-}" in
    -h|--help) sed -n '2,12p' "$0" | sed 's/^# \{0,1\}//'; exit 0 ;;
    gen) qrencode -l H -d 75 -s 10 -o - "$(wl-paste)">~/tmp/qrcode.png ;;
    # select a region to screenshot (or click to screenshot window)
    select) maimselect | clip -t image/png; dunstify "Screenshot" "Screenshot taken" ;;
    # scan a QR code
    qr)
        tmp_file=$(mktemp -t maimscript-XXXXXX)
        grim -g "$(slurp)" "$tmp_file"
        scanresult=$(zbarimg --quiet --raw "$tmp_file" | tr -d '\n')
        if [ -z "$scanresult" ]; then
            dunstify "Screenshot" "No scan data found"
        else
            echo "$scanresult" | clip
            convert "$tmp_file" -resize 75x75 "$tmp_file"
            dunstify -i "$tmp_file" "Screenshot" "$scanresult\n(copied to clipboard)"
        fi
        rm "$tmp_file"
        ;;
    # screenshot the entire desktop
    *)
        grim - | clip -t image/png
        dunstify "Screenshot" "Screenshot taken"
        ;;
esac
