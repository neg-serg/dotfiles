#!/bin/sh
show_help() {
  cat <<'EOF'
Usage: screenshot [-r|-c|-d|-m|-o]
  (no args)  Full screen capture to ~/pic/shots
  -r         Rectangular selection (interactive)
  -c         Current window
  -d         Delayed shot (5s)
  -m         Show menu (rofi)
  -o         OCR region to clipboard (tesseract)
  -h, --help Show this help
EOF
}

scr_dir=$HOME/pic/shots
[ ! -d "$scr_dir" ] && mkdir "$scr_dir"
filename="screenshot-$(date +%Y-%m-%d_%H-%M-%S).png"
summary_="$scr_dir/$filename"

Shot() {
  # Fullscreen screenshot via grim
  grim "$summary_" && ~/bin/pic-notify "$summary_"
}
Select() {
  # Region selection via slurp
  grim -g "$(slurp)" "$summary_" && ~/bin/pic-notify "$summary_"
}
Current() {
  # Try Hyprland active window, fall back to selection
  if command -v hyprctl >/dev/null 2>&1 && command -v jq >/dev/null 2>&1; then
    geo=$(hyprctl -j activewindow | jq -r '"\(.at[0]),\(.at[1]) \(.size[0])x\(.size[1])"') || geo=""
    if [ -n "$geo" ]; then
      grim -g "$geo" "$summary_" && ~/bin/pic-notify "$summary_" && return 0
    fi
  fi
  Select "$@"
}
Delay() { sleep 5; Shot "$@"; }
Full() { Shot "$@"; }

Menu() {
    rofi_cmd="rofi -dmenu -theme clip"
    opts='"Full shot" "Rectangular selection shot" "Current window" "Delayed shot"'
    case $(for opt in $opts; do echo $opt; done | eval $rofi_cmd) in
        -r) Select "$@" ;;
        -f) Full "$@" ;;
        -c) Current "$@" ;;
        -d) Delay "$@" ;;
    esac
}

OCR() {
  grim -g "$(slurp)" - \
    | tesseract --dpi 96 -l eng - - \
    | wl-copy --type text/plain
  notify-send -i ebook-reader "OCR" "Saved to clipboard"
}

case "${1:-}" in
    -r) Select "$@";;
    -c) Current "$@";;
    -d) Delay "$@";;
    -m) Menu "$@";;
    -o) OCR "$@" ;; # thx to vincentbernat
    --help) show_help;;
    -h) show_help;;
    *) Full "$@";;
esac
