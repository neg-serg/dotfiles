#!/usr/bin/env zsh
# sx: view images in swayimg sorted by ctime (newest first)
# Usage: sx DIR...
set -o errexit -o nounset -o pipefail
IFS=$'\n\t'
if [[ "${1:-}" == "-h" || "${1:-}" == "--help" || "$#" -eq 0 ]]; then
  echo "Usage: sx DIR..." >&2; exit 0
fi

swimg_bin="${HOME}/.local/bin/swayimg"
[[ -x "$swimg_bin" ]] || swimg_bin="swayimg"
command -v "$swimg_bin" >/dev/null 2>&1 || { print -u2 'sx: swayimg not found'; exit 1; }

filter_ext() {
  if command -v ug >/dev/null 2>&1; then
    ug -G -iE '\\.(jpe?g|png|gif|svg|webp|tiff|heif|avif|ico|bmp)$'
  else
    grep -Ei '\\.(jpe?g|png|gif|svg|webp|tiff|heif|avif|ico|bmp)$'
  fi
}

"$swimg_bin" -C "${XDG_CONFIG_HOME:-$HOME/.config}/swayimg/config" -g -f -F <(
  find "$@" -type f -printf '%C@ %p\n' \
  | sort -rn \
  | cut -d ' ' -f 2- \
  | cut -d ':' -f 1 \
  | filter_ext
)
